# Configuración de nginx para poliglota.org/testdenivel
# Inserta este bloque location dentro de tu server block existente

location /testdenivel {
    # NO reescribir - Flask maneja el prefijo con middleware
    # Proxy al servicio de App Runner
    proxy_pass https://mg9imrh7j5.us-east-1.awsapprunner.com/testdenivel;

    # Headers necesarios para proxy
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Prefix /testdenivel;

    # Headers para WebSocket (si se necesitan en el futuro)
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    # Timeouts (ajustados para audio transcription que puede tardar)
    proxy_connect_timeout 120s;
    proxy_send_timeout 120s;
    proxy_read_timeout 120s;

    # Buffer settings para archivos grandes (audio)
    client_max_body_size 50M;
    proxy_buffering off;
    proxy_request_buffering off;
}

# Manejo específico de archivos estáticos (si nginx debe cachearlos)
location ~* ^/testdenivel/static/.*\.(css|js|jpg|jpeg|png|gif|ico|svg|webp|json)$ {
    # NO reescribir - Flask maneja el prefijo
    proxy_pass https://mg9imrh7j5.us-east-1.awsapprunner.com;
    proxy_set_header Host mg9imrh7j5.us-east-1.awsapprunner.com;

    # Cache de assets estáticos
    proxy_cache_valid 200 1h;
    proxy_cache_bypass $http_pragma $http_authorization;
    add_header X-Cache-Status $upstream_cache_status;

    # CORS headers si es necesario
    add_header Access-Control-Allow-Origin *;
}
